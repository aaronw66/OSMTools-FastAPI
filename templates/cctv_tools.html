<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV Batch Configuration Tool</title>
    <link rel="icon" href="/static/zy.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/common.css?v=4">
    <link rel="stylesheet" href="/static/css/cctv_tools.css?v=20251008e">
</head>
<body>
    {% include 'navbar.html' %}

    <!-- Main Content -->
    <div class="main-container">
        <div class="cctv-card">
            <div class="card-header">
                <h1 class="card-title">CCTV Batch Configuration Tool</h1>
                <p class="card-subtitle">Manage multiple CCTV devices with batch configuration and firmware updates</p>
            </div>

            <div class="card-body">
                <!-- CSV File Upload -->
                <div class="form-group">
                    <label class="form-label">CSV File</label>
                    <div class="file-upload-row">
                        <input type="file" id="csvFile" accept=".csv">
                        <span class="file-status" id="fileStatus">No file chosen</span>
                        <button class="download-sample-btn" onclick="downloadSample()">
                            üì• Download Sample
                        </button>
                    </div>

                    <div class="csv-info">
                        <p>Upload a CSV file containing device information. Required format:</p>
                        <div class="csv-format">
IP,Room,User,UserSig<br>
192.168.1.100,Room01,user1,signature1<br>
192.168.1.101,Room02,user2,signature2
                        </div>
                    </div>
                </div>

                <!-- Firmware Version -->
                <div class="form-group">
                    <label class="form-label">Firmware Version <span class="required">*</span></label>
                    <select id="firmwareVersion" class="form-select">
                        <option value="">Select firmware version...</option>
                    </select>
                    <div class="form-help">Select the firmware version to install on the devices.</div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn configure-btn" onclick="configureDevices()">
                        <div class="btn-icon">‚öôÔ∏è</div>
                        <div>Configure Devices</div>
                    </button>
                    
                    <button class="action-btn update-btn" onclick="updateFirmware()">
                        <div class="btn-icon">üîÑ</div>
                        <div>Update Firmware</div>
                    </button>
                    
                    <button class="action-btn status-btn" onclick="checkStatus()">
                        <div class="btn-icon">üìä</div>
                        <div>Check Status</div>
                    </button>
                    
                    <button class="action-btn reboot-btn" onclick="rebootDevices()">
                        <div class="btn-icon">üîÑ</div>
                        <div>Reboot Devices</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal">
        <div class="modal-content progress-modal-content">
            <h3 id="progressTitle">Operation Progress</h3>
            <div id="progressText" class="progress-text">Starting...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressStats" class="progress-stats"></div>
            <div id="progressDetails" class="progress-details"></div>
        </div>
    </div>

    <!-- Results Modal -->
    <!-- Configuration Modal -->
    <div id="configurationModal" class="modal">
        <div class="modal-content config-modal-content">
            <span class="close" onclick="closeConfigurationModal()">&times;</span>
            <h3>Device Configuration</h3>
            
            <div class="config-info">
                <p><strong>Total Devices:</strong> <span id="configTotalDevices">0</span></p>
                <p><strong>Operation:</strong> TRTC configuration will be applied to all devices</p>
                <p><strong>Settings:</strong> Room, User, and UserSig values from CSV will be configured</p>
            </div>
            
            <div style="margin: 20px 0; text-align: center;">
                <button class="btn btn-primary" onclick="configureAllDevicesFromModal()">
                    Configure All Devices
                </button>
                <button class="btn btn-secondary" onclick="refreshConfigStatus()" style="background: #17a2b8;">
                    <i class="fas fa-sync-alt"></i> Refresh Status
                </button>
                <button class="btn btn-secondary" onclick="closeConfigurationModal()">
                    Cancel
                </button>
            </div>
            
            <h4>Device List</h4>
            <div class="config-device-table-container">
                <table class="config-device-table">
                    <thead>
                        <tr>
                            <th onclick="sortConfigTable('ip')" style="cursor: pointer;">IP ADDRESS <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortConfigTable('device_name')" style="cursor: pointer;">DEVICE NAME <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortConfigTable('room')" style="cursor: pointer;">ROOM <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortConfigTable('user')" style="cursor: pointer;">USER <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortConfigTable('build_date')" style="cursor: pointer;">BUILD DATE <span class="sort-icon">‚áÖ</span></th>
                            <th onclick="sortConfigTable('status')" style="cursor: pointer;">STATUS <span class="sort-icon">‚áÖ</span></th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="configDeviceList">
                        <!-- Device rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal">
        <div class="modal-content results-modal-content">
            <span class="close" onclick="closeResultsModal()">&times;</span>
            <h3 id="resultsTitle">Operation Results</h3>
            <div id="resultsSummary"></div>
            <div class="results-table-container">
                <div id="resultsContent"></div>
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeResultsModal()">Close</button>
                <button class="btn btn-success" onclick="refreshCheckStatus()">üîÑ Refresh Status</button>
                <button class="btn btn-primary" onclick="downloadResults()">üì• Download CSV</button>
            </div>
        </div>
    </div>

    <!-- Firmware Update Modal -->
    <div id="firmwareUpdateModal" class="modal">
        <div class="modal-content config-modal-content">
            <span class="close" onclick="closeFirmwareUpdateModal()">&times;</span>
            <h3>üì¶ Firmware Update</h3>
            <div class="modal-header-info">
                <p><strong>Firmware:</strong> <span id="firmwareName"></span></p>
                <p><strong>Total Devices:</strong> <span id="firmwareTotalDevices">0</span></p>
            </div>
            <div class="config-device-table-container">
                <table class="config-device-table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Device Name</th>
                            <th>Build Date</th>
                            <th>Model</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="firmwareDeviceList">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeFirmwareUpdateModal()">Close</button>
                <button class="btn btn-primary" onclick="batchUpdateAllFirmware()">üì¶ Batch Update All (10 at a time)</button>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="/static/css/cctv_tools.css?v=20251008e">
    <script src="/static/js/common.js?v=20251010a"></script>
    <script src="/static/js/cctv_tools.js?v=20251008e"></script>
</body>
</html>